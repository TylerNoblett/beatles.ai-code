const json = `{"tempo": 112, "verse_one": [["vi", " c ", 2, 1], ["I", "you", 2, 1], ["vi", " c ", -1, -5], ["I7", " n ", null, 1.5], ["vi", "re", 0, 1], ["I", " c ", 4, 1], ["IV", "lied", 16, 0.5], ["I", " c ", 5, 0.5], ["I7", " c ", 7, 0.25], ["IV", "to", 5, 0.5], ["vi", "Ted", 7, 0.5], ["I", "used", 7, 1], ["I", " c ", 7, 0.5], ["IV", "to", 16, 0.5], ["I", "get", 4, 0.5], ["vi", " c ", 7, 0.5], ["I", "her", 12, 0.5], ["I", "back", 9, 1], ["II", "by", 5, 0.5], ["VII", " c ", 2, 1], ["V", "the", 12, 0.5], ["I", " c ", 17, 0.5], ["vi", " c ", 10, 0.5], ["vi", "bottom", 12, 0.5], ["IV", " c ", 10, 0.5], ["V7", "to", 4, 2.5], ["I", "find", 4, 0.25], ["vi", "the", 9, 0.5], ["I", "mine", 7, 0.5], ["vi", " c ", 7, 2], ["V7", "But", 9, 0.5], ["V", "he", 17, 0.5], ["VII", "did", 14, 0.5], ["vi", "nt", 3, 1.5], ["I", "know", 4, 0.5], ["IV", " c ", 5, 0.5], ["vi", "how", 12, 0.5], ["vi7", "to", 4, 1], ["I", "run", 4, 1], ["I", "it", 4, 0.5], ["IV", "by", 4, 0.5], ["vi", "the", 2, 0.5], ["I", "end", 5, 1], ["V", "of", 5, 0.5], ["V", "the", 4, 0.5], ["V7", "book", 7, 0.5], ["IV", "He", 7, 0.5], ["I", "said", 4, 1], ["V", ":", 2, 0.25]], "verse_two": [["vi", " c ", 2, 1], ["I", "when", 2, 1], ["vi", " c ", -1, -5], ["I7", " n ", null, 1.5], ["vi", "Information", 0, 1], ["I", " c ", 4, 1], ["IV", "the", 16, 0.5], ["I", " c ", 5, 0.5], ["I7", " c ", 7, 0.25], ["IV", "show", 5, 0.5], ["vi", "was", 7, 0.5], ["I", "gone", 7, 1], ["I", " c ", 7, 0.5], ["IV", "More", 16, 0.5], ["I", "than", 4, 0.5], ["vi", " c ", 7, 0.5], ["I", "the", 12, 0.5], ["I", "children", 9, 1], ["II", "in", 5, 0.5], ["VII", " c ", 2, 1], ["V", "life", 12, 0.5], ["I", " c ", 17, 0.5], ["vi", " c ", 10, 0.5], ["vi", "at", 12, 0.5], ["IV", " c ", 10, 0.5], ["V7", "the", 4, 2.5], ["I", "party", 4, 0.25], ["vi", "The", 9, 0.5], ["I", "Free", 7, 0.5], ["vi", " c ", 7, 2], ["V7", "Tonight", 9, 0.5], ["V", "and", 17, 0.5], ["VII", "just", 14, 0.5], ["vi", "beside", 3, 1.5], ["I", "him", 4, 0.5], ["IV", " c ", 5, 0.5], ["vi", "In", 12, 0.5], ["vi7", "the", 4, 1], ["I", "evening", 4, 1], ["I", "Sixty", 4, 0.5], ["IV", "-", 4, 0.5], ["vi", "four", 2, 0.5], ["I", "And", 5, 1], ["V", "three", 5, 0.5], ["V", "four", 4, 0.5], ["V7", "at", 7, 0.5], ["IV", "day", 7, 0.5], ["I", "a", 4, 1], ["V", "shell", 2, 0.25]], "chorus": [["V7", "i", 2, 1], ["I", "m", -1, 1], ["I", "feeling", 7, 0.5], ["IV", "up", 0, 1], ["IV", "for", 7, 1], ["IV", "the", 4, 0.5], ["vi", "One", 7, 0.5], ["I7", "Ma", 7, 0.5], ["I", "Ma", 12, 0.5], ["IV", "ma", 4, 0.5], ["I", "ma", 5, 0.5], ["I", "Ma", 2, 0.25], ["vi", "ma", 9, 1], ["I", "Ma", 7, 0.5], ["I", "ma", 7, 1], ["IV", "ma", 7, 0.5], ["vi", "ma", 5, 0.5], ["I", "ma", 4, 0.5], ["I", " c ", 7, 1], ["I", "ma", 4, 0.5], ["I", " c ", 9, 1], ["I", "ma", 7, 0.5], ["I", " c ", 4, 2], ["IV", " c ", 3, 2], ["I", "Ma", 12, 0.5], ["vi", " n ", null, 0.5], ["I", " c ", 7, 1], ["V7", "ma", 4, 0.5], ["I", "Ma", 4, 0.5], ["V7", "ma", 12, 0.5], ["I", " c ", 4, 0.75], ["I", "ma", 7, 1], ["IV", " c ", 5, 1], ["I", " 12 ", 3, 0.5], ["VII", "Ma", 4, 0.5], ["IV", " n ", null, 4], ["I", "ma", 7, 1], ["I", "Ma", 7, 0.5], ["V7", "ma", 2, 1], ["bVI", "ma", 12, 1], ["V7", " c ", 7, 1], ["I", "ma", 11, 1]], "bridge": [["IV", " c ", 9, 3], ["IV", " n ", null, 1.5], ["V", " c ", 2, 0.5], ["I", "cant", 12, 0.5], ["I", "she", 7, 0.5], ["IV", "shake", 12, 0.5], ["I", " c ", 5, 2], ["IV", "in", 12, 2], ["I", "the", 2, 1], ["V7", "dark", 4, 0.5], ["viDim", " c ", 7, 1], ["I", "She", 12, 0.5], ["I", "s", 10, 1], ["I", "got", 7, 0.25], ["I", "a", 4, 1], ["I", "guitar", 4, 0.5], ["V", "to", 5, 0.5], ["I", " c ", 4, 0.5], ["I", "tell", 11, 0.5], ["I7", "her", 2, 2], ["vi", "that", 5, 0.5], ["IV", "she", 7, 0.5], ["IV", "will", 0, 0.5], ["IV", "be", 4, 0.5], ["I", "too", 4, 0.5], ["I", "rich", 0, 0.5], ["IV", " c ", 2, 1], ["IV", " c ", 10, 0.5], ["I", "in", 7, 0.5], ["I", " c ", 2, 0.5], ["vi", "the", 11, 1], ["I", "universe", 10, 0.5], ["I", " c ", 9, 1], ["vi", "She", 7, 0.5], ["I7", " n ", null, 0.5]]}`;
const musicObj = JSON.parse(json);
const verseOne = musicObj.verse_one;
const verseTwo = musicObj.verse_two;
const chorus = musicObj.chorus;
const bridge = musicObj.bridge;


let abcString = `T:New Beatles Song\nM: 4/4\nL: 1/4\nQ: ${musicObj.tempo}\nK: G\n`;
// TODO: maybe if it's mobile just print one bar instead of two?

const toneMapping = {
  "-7": "C",
  "-6": "^C",
  "-5": "D",
  "-4": "_E",
  "-3": "E",
  "-2": "=F",
  "-1": "F", 
  "0": "G",
  "1": "^G",
  "2": "A",
  "3": "_B",
  "4": "B",
  "5": "c",
  "6": "^c",
  "7": "d",
  "8": "_e",
  "9": "e",
  "10": "=f",
  "11": "f", 
  "12": "g",
  "13": "^g",
  "14": "a",
  "15": "^a",
  "16": "b",
}

const chordMapping = {
  "i": "Gm",
  "I": "G",
  "I6": "G6",
  "I7": "G7",
  "Isus": "Gsus",
  "I/vi": "G/Em",
  "I/vii": "G/F#",
  "I/V": "G/D",
  "Imaj7": "Gmaj7",
  "ii": "Am",
  "ii7": "Am7",
  "II": "A",
  "II7": "A7",
  "bIII": "Bb",
  "iii": "Bmin",
  "iii7": "Bmin7",
  "III": "B",
  "III7": "B7",
  "iv": "Cm",
  "iv7": "Cm7",
  "IV": "C",
  "IV7": "C7",
  "IV/V": "C/D",
  "v": "Dmin",
  "V": "D",
  "V7": "D7",
  "Vsus": "Dsus",
  "V/I": "D/G",
  "bVI": "Eb",
  "vi": "Em",
  "vi6": "Em6",
  "vi7": "Em7",
  "vi/V": "Em/D",
  "vi/VII": "Em/#F",
  "VI": "E",
  "VI7": "E7",
  "vidim": "Edim",
  "VII": "F",
  "VIImaj7": "Fmaj7",
  "vii": "F#dim",
}

const lengthMapping = {
  0.125: '/8',
  0.17: '/6',
  0.25: '/4',
  0.33: '1/3',
  0.5: '/2',
  0.66: '2/3',
  0.75: '3/4',
  1: '',
  1.25: '5/4',
  1.33: '4/3',
  1.5: '3/2',
  1.66: '5/3',
  1.75: '7/4',
  2: '2',
  2.25: '9/4',
  2.33: '7/3',
  2.5: '5/2',
  2.66: '8/3',
  2.75: '11/4',
  3: '3',
  3.25: '13/4',
  3.33: '10/3',
  3.5: '7/2',
  3.66: '11/3',
  3.75: '15/4',
  4: '4',
  5: '5',
  6: '6',
  7: '7',
  8: '8',
}


const strIsContinuation = (str) => str === ' c ';
const strIsRest = (str) => str === ' n ';
const createABCData = (songSegment) => {
  let bar = 0;
  let music = '';
  let lyrics = '';
  let previousChord = '';
  let previousBar = 0;
  let continueTone = false;
  // TODO: how to handle continutations?
  // chagne this to for / in loop?
  // Do I need to access i?
  // or even a forEach/Map?
  for (i = 0; i < songSegment.length; i++){
    const grouping = songSegment[i];
       
    //TODO: move this function out of createABCData?
    const breakMusicApart = (grouping) => {      
      // TODO: move this out of breakMusicApart?
      // Move vars into this instead of taking as args?
      const handleGrouping = (grouping) => {
        const chord = chordMapping[grouping[0]];
        const toneOrRest = toneMapping[grouping[2]];
        let tone = toneOrRest ? toneOrRest : 'z';
        tone = continueTone ? "-" + tone : tone;
        let lyric = grouping[1];
        const length = +grouping[3].toFixed(2);
        const abcLength = !lengthMapping[length] && length === 1 ? lengthMapping[length] : '/2';
        previousBar = bar;
        bar += length
        continueTone = false

        if (strIsContinuation(lyric) || strIsRest(lyric)){
          lyric = '* ';
        }
        lyrics += `${lyric} `;

        if (previousChord !== chord) {
          music += `"${chord}"`;
          previousChord = chord;
        }
        music += `${tone + abcLength}`;

        if(bar === 4){
          abcString += `${music}|\nw: ${lyrics}\n` 
          bar = 0;
          music = '';
          lyrics = '';
        } 
      }
      
      if (bar + grouping[3] <= 4) {
         handleGrouping(grouping)
        // TODO: separte bit where bar === 4 into own thing?
      } else {
        const endOfLineGrouping = grouping;
        const originalLength = grouping[3];
        // length of bar before it was given this length and minus 4
        // so that the bar === 4
        endOfLineGrouping[3] = 4 - bar
        handleGrouping(endOfLineGrouping, true)

        continueTone = true
        newGrouping = grouping;
        newGrouping[1] = " c ";
        newGrouping[2] = grouping[2];
        // newGrouping[3] = 4 - originalLength;
        newGrouping[3] = originalLength - endOfLineGrouping[3];
        // TODO: maybe? reset previousChord to '' so Chords get printed again?
        // call function on this grouping before loop continues
        breakMusicApart(newGrouping);
      }
    }
    breakMusicApart(grouping);
  }
}
// Create the verses together - two lines of lyrics
// put the chorus at the end and repeat it
// bridge
// chorus (maybe use a coda?)
createABCData(verseOne)
createABCData(chorus)
createABCData(verseTwo)
createABCData(chorus)
createABCData(bridge)
createABCData(chorus)

console.log(abcString)
